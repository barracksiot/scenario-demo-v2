#!/bin/bash
set -e

OLD_BARRACKS_ENABLE_V2=$BARRACKS_ENABLE_V2
export BARRACKS_ENABLE_V2="1"

echo "-----------------------------------------"
echo "-- Installing / upgrading barracks CLI..."
echo "-----------------------------------------"
npm install -g barracks-cli
npm install

echo "-----------------------------------------"
echo "-- Connecting to account ${LOGIN}"
echo "-----------------------------------------"
if [ -e "~/.barracks/barracks.json" ]; then
  rm -rf "~/.barracks/barracks.json"
fi
barracks login

echo "-----------------------------------------"
echo "-- Creating 'All' filter..."
echo "-----------------------------------------"
barracks filter create --name all --query '{ "regex": { "unitId":".*" } }'
echo "-----------------------------------------"
echo "-- Creating 'Screen' filter..."
echo "-----------------------------------------"
barracks filter create --name screen --query '{ "eq": { "customClientData.modules.screen":true } }'

echo "-----------------------------------------"
echo "-- Creating firmware for screen"
echo "-----------------------------------------"
barracks package create --reference io.barracks.firmware.screen --name "Screen Firmware"
barracks package version create --versionId v1 --name "Version 1" --packageReference io.barracks.firmware.screen --file packages/screen_firmware.js 

echo "-----------------------------------------"
echo "-- Uploading deployment plan for App 1..."
echo "-----------------------------------------"
cat packages/screen_firmware_plan.json | barracks package plan publish

barracks logout

export BARRACKS_ENABLE_V2=$OLD_BARRACKS_ENABLE_V2

